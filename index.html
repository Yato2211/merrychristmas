<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Magic Christmas â€“ Beautiful Tree</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
body { margin:0; overflow:hidden; background:#000; }
#ui {
    position:absolute; bottom:30px; width:100%; text-align:center; z-index:10;
}
button {
    padding:15px 50px;
    font-size:16px;
    font-weight:bold;
    border-radius:30px;
    border:2px solid gold;
    background:linear-gradient(#D32F2F,#8B0000);
    color:#fff;
    cursor:pointer;
}
#camera-preview {
    position:absolute; top:10px; right:10px;
    width:120px; height:90px;
    opacity:.6; border:2px solid red;
    transform:scaleX(-1);
}
</style>
</head>

<body>

<div id="ui">
    <button onclick="start()">START MAGIC</button>
</div>

<video class="input_video" style="display:none"></video>
<canvas id="camera-preview"></canvas>

<script>
/* ================== BASIC ================== */
let scene, camera, renderer;
let groupTree, groupLights;
let star;
let state = 'TREE';
let handX = 0.5;

const CONFIG = {
    treeHeight: 80,
    treeBaseRadius: 40,
    leafCount: 2600,
    lightCount: 400
};

const music = new Audio("./audio.mp3");
music.loop = true;

/* ================== INIT ================== */
function start() {
    music.play().catch(()=>{});
    init3D();
    initHand();
}

function init3D() {
    scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.002);

    camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    camera.position.z = 120;

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    document.body.appendChild(renderer.domElement);

    createTree();
    createLights();
    createTrunk();
    createStar();

    animate();
}

window.addEventListener('resize',()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
});

/* ================== TREE ================== */
function createTree() {
    const pos = [];
    const colors = [];
    const color = new THREE.Color(0.2, 0.9, 0.4);

    const layers = 6;

    for(let i=0;i<CONFIG.leafCount;i++){
        const h = Math.random() * CONFIG.treeHeight;
        const y = h - CONFIG.treeHeight/2;

        const layer = Math.floor((h / CONFIG.treeHeight) * layers);
        const layerH = CONFIG.treeHeight / layers;
        const localH = (h - layer * layerH) / layerH;

        const taper = 1 - localH;
        const maxR = (1 - layer / layers) * CONFIG.treeBaseRadius * taper;

        const r = Math.random() * maxR;
        const a = Math.random() * Math.PI * 2;

        pos.push(
            Math.cos(a)*r,
            y,
            Math.sin(a)*r
        );

        const shade = 0.6 + Math.random()*0.4;
        colors.push(color.r*shade, color.g*shade, color.b*shade);
    }

    const geo = new THREE.BufferGeometry();
    geo.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));
    geo.setAttribute('color', new THREE.Float32BufferAttribute(colors,3));

    const mat = new THREE.PointsMaterial({
        size:2.2,
        vertexColors:true,
        transparent:true
    });

    groupTree = new THREE.Points(geo, mat);
    scene.add(groupTree);
}

/* ================== LIGHTS ================== */
function createLights() {
    const pos = [];

    for(let i=0;i<CONFIG.lightCount;i++){
        const t = i / CONFIG.lightCount;
        const y = t*CONFIG.treeHeight - CONFIG.treeHeight/2;
        const r = (1-t)*CONFIG.treeBaseRadius*0.95;
        const a = t*Math.PI*14;

        pos.push(
            Math.cos(a)*r,
            y,
            Math.sin(a)*r
        );
    }

    const geo = new THREE.BufferGeometry();
    geo.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));

    const mat = new THREE.PointsMaterial({
        size:3,
        color:0xFFD700,
        transparent:true,
        blending:THREE.AdditiveBlending
    });

    groupLights = new THREE.Points(geo, mat);
    scene.add(groupLights);
}

/* ================== TRUNK ================== */
function createTrunk() {
    const geo = new THREE.CylinderGeometry(4,5,20,16);
    const mat = new THREE.MeshBasicMaterial({color:0x5D4037});
    const trunk = new THREE.Mesh(geo,mat);
    trunk.position.y = -CONFIG.treeHeight/2 - 10;
    scene.add(trunk);
}

/* ================== STAR ================== */
function createStar() {
    const c = document.createElement("canvas");
    c.width = c.height = 128;
    const ctx = c.getContext("2d");
    ctx.fillStyle="#FFD700";
    ctx.shadowColor="#FFF";
    ctx.shadowBlur=20;
    ctx.beginPath();
    for(let i=0;i<5;i++){
        ctx.lineTo(
            64 + Math.cos((18+i*72)/180*Math.PI)*50,
            64 - Math.sin((18+i*72)/180*Math.PI)*50
        );
        ctx.lineTo(
            64 + Math.cos((54+i*72)/180*Math.PI)*20,
            64 - Math.sin((54+i*72)/180*Math.PI)*20
        );
    }
    ctx.fill();

    const tex = new THREE.CanvasTexture(c);
    const mat = new THREE.MeshBasicMaterial({
        map:tex,
        transparent:true,
        blending:THREE.AdditiveBlending
    });

    star = new THREE.Mesh(new THREE.PlaneGeometry(15,15),mat);
    star.position.y = CONFIG.treeHeight/2 + 5;
    scene.add(star);
}

/* ================== HAND ================== */
function initHand(){
    const video = document.querySelector('.input_video');
    const canvas = document.getElementById('camera-preview');
    const ctx = canvas.getContext('2d');

    const hands = new Hands({
        locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
    });

    hands.setOptions({
        maxNumHands:1,
        minDetectionConfidence:0.6,
        minTrackingConfidence:0.6
    });

    hands.onResults(r=>{
        ctx.clearRect(0,0,120,90);
        ctx.drawImage(r.image,0,0,120,90);

        if(r.multiHandLandmarks.length){
            handX = r.multiHandLandmarks[0][9].x;
        }
    });

    new Camera(video,{
        onFrame:()=>hands.send({image:video}),
        width:320,height:240
    }).start();
}

/* ================== ANIMATE ================== */
function animate(){
    requestAnimationFrame(animate);
    const t = Date.now()*0.001;

    groupTree.rotation.y += 0.002;
    groupLights.rotation.y += 0.004;
    groupLights.material.opacity = 0.5 + Math.sin(t*5)*0.5;

    star.rotation.z += 0.02;
    star.scale.setScalar(1.1 + Math.sin(t*6)*0.2);

    renderer.render(scene,camera);
}
</script>

</body>
</html>