<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Magic Christmas</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
body {
    margin: 0;
    overflow: hidden;
    background: black;
}

#canvas-container {
    width: 100%;
    height: 100vh;
}

/* ===== CAMERA PREVIEW ===== */
#camera-preview {
    position: absolute;
    top: 15px;
    right: 15px;

    width: 120px;     /* GIá»® NGUYÃŠN */
    height: 90px;     /* GIá»® NGUYÃŠN */

    border: 2px solid rgba(255,0,0,0.6);
    border-radius: 10px;
    transform: scaleX(-1);
    opacity: 0.8;
    background: black;
    z-index: 100;
}

/* UI */
#ui-layer {
    position: absolute;
    bottom: 20px;
    width: 100%;
    text-align: center;
    color: white;
    font-size: 14px;
    z-index: 50;
}

button {
    padding: 14px 40px;
    border-radius: 30px;
    border: none;
    font-size: 16px;
    font-weight: bold;
    background: red;
    color: white;
}
</style>
</head>

<body>

<div id="canvas-container"></div>

<div id="ui-layer">
    âœ‹ Open: Explode | ðŸ«¶ Heart: Love | âœŠ Fist: Tree <br><br>
    <button onclick="startSystem()">START MAGIC</button>
</div>

<video class="input_video" style="display:none"></video>
<canvas id="camera-preview"></canvas>

<script>
/* =========================
   THREE.JS BASIC
========================= */
let scene, camera, renderer;
let state = 'TREE';
let handX = 0.5;

function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 100;

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    animate();
}

function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
}

/* =========================
   START SYSTEM
========================= */
function startSystem() {
    init3D();

    const video = document.querySelector('.input_video');
    const canvas = document.getElementById('camera-preview');
    const ctx = canvas.getContext('2d');

    /* ðŸ”¥ QUAN TRá»ŒNG: set canvas Ä‘Ãºng size CSS */
    canvas.width  = canvas.clientWidth;
    canvas.height = canvas.clientHeight;

    const hands = new Hands({
        locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(results => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (results.image) {
            /* ===== FIX FIT CAMERA VÃ€O KHUNG ===== */
            const iw = results.image.width;
            const ih = results.image.height;
            const cw = canvas.width;
            const ch = canvas.height;

            const scale = Math.max(cw / iw, ch / ih);
            const nw = iw * scale;
            const nh = ih * scale;

            const x = (cw - nw) / 2;
            const y = (ch - nh) / 2;

            ctx.drawImage(results.image, x, y, nw, nh);
        }

        /* ---- HAND LOGIC ---- */
        if (results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            handX = lm[9].x;

            const tips = [8,12,16,20];
            const wrist = lm[0];
            let openDist = 0;

            tips.forEach(i => {
                openDist += Math.hypot(lm[i].x - wrist.x, lm[i].y - wrist.y);
            });

            openDist /= 4;
            const pinch = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);

            if (openDist < 0.25) state = 'TREE';
            else if (pinch < 0.05) state = 'PHOTO';
            else state = 'EXPLODE';
        } else {
            state = 'TREE';
        }
    });

    const cam = new Camera(video, {
        onFrame: async () => {
            await hands.send({ image: video });
        },
        width: 320,
        height: 240
    });

    cam.start();
}

/* Resize */
window.addEventListener('resize', () => {
    if (!camera) return;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
